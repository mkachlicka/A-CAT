name: Build ACAT Executables

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12']
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Poetry
      run: |
        pip install poetry
    
    - name: Install dependencies
      run: |
        poetry install
    
    - name: Install FFmpeg (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        echo "_ACAT_FFMPEG_PATH=$(which ffmpeg)" >> $GITHUB_ENV
    
    - name: Install FFmpeg (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install ffmpeg
        echo "_ACAT_FFMPEG_PATH=$(which ffmpeg)" >> $GITHUB_ENV
    
    - name: Install FFmpeg (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install ffmpeg -y
        $ffmpegPath = (Get-Command ffmpeg).Path
        echo "_ACAT_FFMPEG_PATH=$ffmpegPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh
    
    - name: Build executable
      run: |
        poetry run python -c "from build_script import test_build; test_build()"
    
    - name: Upload artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: ACAT-macOS
        path: dist/ACAT.app
        retention-days: 30
    
    - name: Upload artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ACAT-Windows
        path: dist/ACAT
        retention-days: 30
    
    - name: Upload artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ACAT-Linux
        path: dist/ACAT
        retention-days: 30
